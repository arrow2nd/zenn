---
title: "iceberg.vimã‚’å£Šã—ã¦ã—ã¾ã£ãŸè©±"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [vim, neovim]
published: false
published_at: 2022-12-07 07:00
---

:::message
ã“ã®è¨˜äº‹ã¯Vim Advent Calendar 2022ã®7æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
:::

# ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ã€ã‚ã‚ãƒ¼ã§ã™ã€‚

åŠå¹´å‰ãã‚‰ã„ã«VSCodeã‹ã‚‰Vimã¸ç§»è¡Œã—ãŸã°ã‹ã‚Šã®åˆå¿ƒè€…ã§ã™ã€‚
ç¾åœ¨ã¯Neovimã‚’ãƒ¡ã‚¤ãƒ³ã«ä½¿ã£ã¦ã„ã¾ã™ã€‚

æœ¬æ¥ã¯Vimã«å…¥é–€ã—ãŸè©±ã‚’æ›¸ã“ã†ã¨æ€ã£ã¦ã„ãŸã®ã§ã™ãŒã€è‡ªæˆ’ã®å¿µã‚’è¾¼ã‚ã¦ã“ã®è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã¾ã™â€¦ã€‚

## iceberg.vimã£ã¦ï¼Ÿ

iceberg.vimã¯[cocopon](https://github.com/cocopon)ã•ã‚“ãŒé–‹ç™ºã•ã‚Œã¦ã„ã‚‹ã€Vimãƒ»Neovimå¯¾å¿œã®ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ ã§ã™ã€‚
ãƒ€ãƒ¼ã‚¯ãƒ–ãƒ«ãƒ¼ã‚’åŸºèª¿ã¨ã—ã¦ã„ã¦è¦–èªæ€§ãŒã‚ˆãã€ã‹ã£ã“ã‚ˆãã¦ã‹ã‚ã„ã„ã®ã§æ„›ç”¨ã—ã¦ã„ã¾ã™ã€‚

![iceberg](/images/324f3a00c3ca59/iceberg.png)

https://cocopon.github.io/iceberg.vim/

# ä½•ã‚’ã—ãŸã®ã‹

[Treesitter](https://github.com/nvim-treesitter/nvim-treesitter)ã®ç ´å£Šçš„ãªå¤‰æ›´ã«ã‚ˆã£ã¦ã€æ­£ã—ãè‰²ãŒã¤ã‹ãªããªã£ã¦ã„ãŸã®ã‚’ä¿®æ­£ã™ã‚‹PRã‚’å‡ºã—ã¾ã—ãŸã€‚

![ä¿®æ­£å‰](/images/324f3a00c3ca59/before.png)
_è‰²ãŒã¤ã‹ãªããªã£ã¦ã„ã‚‹æ§˜å­_

![ä¿®æ­£å¾Œ](/images/324f3a00c3ca59/after.png)
_æœ¬æ¥ã¯ã“ã†ãªã£ã¦ã„ã‚‹ã¹ã_

https://github.com/cocopon/iceberg.vim/pull/107

## çµŒç·¯

ä»Šå›åŸå› ã«ãªã£ãŸTreesitterã®ç ´å£Šçš„ãªå¤‰æ›´ã¯ **æ—¢å­˜ã® `TS` ã§å§‹ã¾ã‚‹ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãŒ`@`ã‹ã‚‰å§‹ã¾ã‚‹ã‚‚ã®ã«ç½®ãæ›ã‚ã£ãŸ** ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

ã“ã®å¤‰æ›´ã¯ä»¥ä¸‹ã®PRã§å–ã‚Šè¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/nvim-treesitter/nvim-treesitter/pull/3656

ã€Œç½®ãæ›ã‚ã£ãŸã ã‘ãªã‚‰ã€ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ ã®æ–¹ã§ã‚‚ãã®ã¾ã¾ç½®ãæ›ãˆã‚Œã°ã„ã‘ãã†ï¼ã€
ã¨æ€ã£ãŸã®ã§ã€æ„šç›´ã«ç½®ãæ›ãˆã¾ã—ãŸã€‚

![å¤‰æ›´ç®‡æ‰€](/images/324f3a00c3ca59/diff_1.png)
_`TS*`ã‚’`@*`ã«ç½®æ›_

ãã®å¾Œã€ã¡ã‚‡ã£ã¨èª¿æ•´ã—ãŸã‚Šã—ã¦â€¦

![è¿½åŠ ç®‡æ‰€](/images/324f3a00c3ca59/diff_2.png)
_`TS*`ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã‚’æˆ»ã—ãŸ_

ç„¡äº‹ã«ãƒãƒ¼ã‚¸ã—ã¦ã„ãŸã ã‘ã¾ã—ãŸ âœŒï¸

![ã‚³ãƒ¡ãƒ³ãƒˆ](/images/324f3a00c3ca59/comment_1.png)

# å£Šã‚ŒãŸ

ã¨å–œã‚“ã§ã„ãŸã®ã‚‚æŸã®é–“ã€ä»¥ä¸‹ã®ã‚ˆã†ãªIssueãŒç«‹ã¡ã¾ã—ãŸã€‚

https://github.com/cocopon/iceberg.vim/issues/108

ã€ŒVimã§èª­ã¿è¾¼ã‚“ã éš›ã«è­¦å‘Š `W18: Invalid character in group name happens` ãŒå‡ºã¾ãã‚‹ã€ã¨ã„ã†å†…å®¹ã§ã™ã€‚

ã©ã†è€ƒãˆã¦ã‚‚ç§ã®è¡Œã£ãŸå¤‰æ›´ãŒåŸå› ãªã®ã§ã€æ€¥ã„ã§èª¿æŸ»ã«å–ã‚Šæ›ã‹ã‚Šã¾ã—ãŸâ€¦ã€‚

## ãªãœå£Šã‚ŒãŸã®ã‹

çµè«–ã‹ã‚‰è¨€ã†ã¨ã€åŸå› ã¯**Vimã¨Neovimã¨ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚°ãƒ«ãƒ¼ãƒ—åã«ä½¿ãˆã‚‹æ–‡å­—ãŒç•°ãªã‚‹**ã“ã¨ã§ã—ãŸã€‚

Vimã§ä½¿ç”¨ã§ãã‚‹æ–‡å­—ã¯ `[a-zA-Z0-9_]` ã§ã™ãŒã€**Neovim v0.8ã‹ã‚‰ `.` ã¨ `@` ã‚’è¶³ã—ãŸ `[a-zA-Z0-9_.@]` ãŒä½¿ç”¨ã§ãã‚‹**ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

https://github.com/neovim/neovim/releases/tag/v0.8.0

Vimï¼ˆã‚‚ã—ãã¯Neovim v0.7ä»¥å‰ï¼‰ã§ã¯ `@` ãŒä½¿ç”¨ã§ããªã„ãŸã‚ `Invalid character in group name` ã¨ã„ã†è­¦å‘ŠãŒå‡ºã¦ã„ãŸã€ã¨ã„ã†è¨³ã§ã™ã€‚

# ä¿®æ­£ã™ã‚‹

ä¸Šè¨˜ã®ç†ç”±ã‹ã‚‰ã€`@*` ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã‚’Neovim v0.8ä»¥é™ã®å ´åˆã«ã®ã¿å®šç¾©ã™ã‚‹ã‚ˆã†ä¿®æ­£ã™ã‚Œã°è‰¯ã•ãã†ã§ã™ã€‚

iceberg.vimã¯[pgmnt.vim](https://github.com/cocopon/pgmnt.vim)ã¨ã„ã†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã§ç”Ÿæˆã™ã‚‹å½¢ã‚’å–ã£ã¦ã„ã‚‹ã®ã§ã€ãã¡ã‚‰ã®ã‚³ãƒ¼ãƒ‰ã‚’è§¦ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## src/iceberg.vim

ã€Œä»Šå¾Œã€Treesitterä»¥å¤–ã«ã‚‚Neovimã«ä¾å­˜ã—ãŸãƒã‚¤ãƒ©ã‚¤ãƒˆã‚°ãƒ«ãƒ¼ãƒ—åã‚’ä½¿ã†ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚ã‚‹ã‹ã‚‚ã€ã¨æ€ã£ãŸã®ã§ã€è¿½åŠ ã—ã‚„ã™ã„ã‚ˆã†è©²å½“ã™ã‚‹éƒ¨åˆ†ã‚’é–¢æ•°ã«ã¾ã¨ã‚ã¾ã—ãŸã€‚

ã¯ã˜ã‚ã«å‡ºã—ãŸPRã¨ã¯ç•°ãªã‚Šã€å…ƒã€…å®šç¾©ã•ã‚Œã¦ã„ãŸ `TS*` ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã«ãƒªãƒ³ã‚¯ã•ã›ã‚‹å½¢ã‚’å–ã£ã¦ã„ã¾ã™ã€‚

```vim:iceberg.vim
function! s:create_neovim_08_links() abort
  let links = []

  call add(links, pgmnt#hi#link('@attribute', 'TSAttribute'))
  call add(links, pgmnt#hi#link('@boolean', 'TSBoolean'))
  call add(links, pgmnt#hi#link('@character', 'TSCharacter'))
  call add(links, pgmnt#hi#link('@comment', 'TSComment'))
  call add(links, pgmnt#hi#link('@constructor', 'TSConstructor'))
  call add(links, pgmnt#hi#link('@conditional', 'TSConditional'))
  call add(links, pgmnt#hi#link('@constant', 'TSConstant'))
  call add(links, pgmnt#hi#link('@constant.builtin', 'TSConstBuiltin'))
  call add(links, pgmnt#hi#link('@constant.macro', 'TSConstMacro'))

  " çœç•¥...

  return links
endfunction
```

`create_context()` ã®æˆ»ã‚Šå€¤ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ã®ã§ã€ã“ã“ã§å…ˆã»ã©ä½œã£ãŸé–¢æ•°ã‚’å‘¼ã³ã€æˆ»ã‚Šå€¤ã«è¿½åŠ ã—ã¾ã™ã€‚

```diff vim:iceberg.vim
 function! s:create_context() abort
   " çœç•¥...
   let neovim_08_links = s:create_neovim_08_links()
 
   return {
         \   'modified': strftime('%Y-%m-%d %H:%M%z'),
         \   'dark_rules': d.rules,
         \   'dark_neovim_term_defs': d.neovim_term_defs,
         \   'dark_vim_term_defs': d.vim_term_defs,
         \   'light_rules': l.rules,
         \   'light_neovim_term_defs': l.neovim_term_defs,
         \   'light_vim_term_defs': l.vim_term_defs,
         \   'links': links,
+        \   'neovim_08_links': neovim_08_links,
         \ }
 endfunction
```

## src/template.vim

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¸ `create_context()` ã«æ–°ã—ãè¿½åŠ ã—ãŸæˆ»ã‚Šå€¤ã®åå‰ã‚’åŸ‹ã‚è¾¼ã¿ã¾ã™ã€‚

`has('nvim-0.8')` ã§Neovim v0.8ä»¥ä¸Šãªã®ã‹ã‚’å–å¾—ã§ãã‚‹[^1]ã®ã§ã€ãã‚Œã‚’ä½¿ã£ã¦åˆ†å²ã•ã›ã¦ã„ã¾ã™ã€‚

```diff vim:template.vim
 " çœç•¥...
 {{ links }}

+ if has('nvim-0.8')
+   {{ neovim_08_links }}
+ endif

 if !has('nvim')
   hi! link SpecialKey Whitespace
 endif
```

ã“ã‚Œã§ä»Šåº¦ã“ãTreesitterã®å¤‰æ›´ã«å¯¾å¿œã§ãã¾ã—ãŸï¼

https://github.com/cocopon/iceberg.vim/pull/110

# æœ€å¾Œã«

Neovimã«ã¤ã„ã¦ã€Œãªã‚“ã‹Vimã‚’å¼·ãã—ãŸã‚„ã¤ã€ãã‚‰ã„ã®èªè­˜ã§ã„ãŸã®ã§ã€æ”¹ã‚ã¦ä¸¡è€…ã®é•ã„ã‚’èª¿ã¹ã‚‹è‰¯ã„ãã£ã‹ã‘ã«ãªã£ãŸãªã¨æ€ã„ã¾ã™ã€‚

ã¾ãŸã€[vim-jp](https://vim-jp.org/)ã®Slack[^2]ã§ã‚‚ä»Šå›ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆå‘¨ã‚Šã®ä»¶ãŒè©±é¡Œã«ã‚ãŒã£ã¦ãŠã‚Šã€Neovimæœ¬ä½“ã®Issueãƒ»PRã®å†…å®¹ã‚’äº¤ãˆãªãŒã‚‰ãŠè©±ã•ã‚Œã¦ã„ã¦ã€ã¨ã¦ã‚‚å‹‰å¼·ã«ãªã‚Šã¾ã—ãŸã€‚

æœ€å¾Œã«ãªã‚Šã¾ã™ãŒã€ä»Šå›PRã®å¯¾å¿œã‚’ã—ã¦ãã ã•ã£ãŸcocoponã•ã‚“ã‚’ã¯ã˜ã‚ã€ã‚³ãƒ¡ãƒ³ãƒˆã«ã¦ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã£ãŸæ–¹ã€…ã«ã¯é ­ãŒä¸ŠãŒã‚Šã¾ã›ã‚“ã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸâ€¦ï¼

[^1]: ã“ã¡ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã§æ•™ãˆã¦ã„ãŸã ãã¾ã—ãŸ ğŸ™
https://github.com/cocopon/iceberg.vim/pull/110#issuecomment-1316889285
[^2]: https://vim-jp.org/docs/chat.html
