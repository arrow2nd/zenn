---
title: "Deno + FFmpeg ã§ Twitter ã‹ã‚‰ã‚·ãƒ£ãƒ‹ãƒã‚¹ã®ã‚¬ã‚·ãƒ£ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚´ã‚’é›†ã‚ãŸã„ï¼"
emoji: "ğŸ—‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Twitter", "Deno", "FFmpeg"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã¯Qiitaã¸æŠ•ç¨¿ã—ãŸè¨˜äº‹ã«åŠ ç­†ãƒ»ä¿®æ­£ã‚’æ–½ã—ãŸã‚‚ã®ã§ã™
:::

# ã¾ãˆãŒã

[ã‚¢ã‚¤ãƒ‰ãƒ«ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼ã‚«ãƒ©ãƒ¼ã‚º](https://shinycolors.idolmaster.jp) ã¯ãƒãƒ³ãƒ€ã‚¤ãƒŠãƒ ã‚³ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆãŒé‹å–¶ã™ã‚‹ã€ã€ŒTHE IDOLM@STERã‚·ãƒªãƒ¼ã‚ºã€ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚²ãƒ¼ãƒ ã§ã™ã€‚

ã“ã®ã‚·ãƒ£ãƒ‹ãƒã‚¹ã€ã¨ã«ã‹ãã€Œã‚¤ãƒ©ã‚¹ãƒˆãŒã™ã”ããã‚Œã„ã€ãªã®ã§ã™ãŒã€**ãƒ­ã‚´ã‚‚ã™ã£ã”ããã‚Œã„** ãªã‚“ã§ã™ã‚ˆã­â€¦ã€‚

ãã‚“ãªãƒ­ã‚´ãŸã¡ã‚’é›†ã‚ã¦ã„ã¤ã§ã‚‚è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã„ï¼

# æ–¹æ³•

ã‚¬ã‚·ãƒ£ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆã¨ã‚‚ã«ã€é–‹å‚¬å‰ã«Twitterã¸ä»¥ä¸‹ã®ã‚ˆã†ãªå‹•ç”»ãŒæŠ•ç¨¿ã•ã‚Œã‚‹ã®ã§ã€ä»Šå›ã¯ã“ã®å‹•ç”»ã‚’ä¿å­˜ã€‚
ãã‚Œã‹ã‚‰ãƒ­ã‚´ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ç”»åƒã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

https://twitter.com/imassc_official/status/1336189011870748673?s=20&t=mo2QUP7K4r4M83BtfapQDw

# ç’°å¢ƒ

- macOS Monterey 12.3ï¼ˆIntelï¼‰
- zsh
- Python / Denoã®ç’°å¢ƒãŒã‚ã‚‹
- Twitterã®é–‹ç™ºè€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚‹

# æ‰‹é †

## 1. ãƒ„ã‚¤ãƒ¼ãƒˆã‚’é›†ã‚ã‚‹

Twitterã® [Recent search API](https://developer.twitter.com/en/docs/twitter-api/tweets/search/api-reference) ã§ã¯ç›´è¿‘7æ—¥é–“ã®ãƒ„ã‚¤ãƒ¼ãƒˆã—ã‹æ¤œç´¢ã§ããªã„ã®ã§ã€ï¼ˆè‹¦è‚‰ã®ç­–ã¨ã—ã¦ï¼‰Pythonè£½ãƒ„ãƒ¼ãƒ«ã® [Twint](https://github.com/twintproject/twint) ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚

```sh
pip3 install twint
```

[Basic-usage](https://github.com/twintproject/twint/wiki/Basic-usage) ã‚’èª­ã¿ã¤ã¤ã€æ¤œç´¢ã—ã¦ã„ãã¾ã™ã€‚

```sh
# ã€Œå¾©åˆ»ã‚’é™¤ãã‚·ãƒŠãƒªã‚ªã‚¤ãƒ™ãƒ³ãƒˆã‹ã¤ã€å‹•ç”»ãŒã‚ã‚‹ãƒ„ã‚¤ãƒ¼ãƒˆã€ã‚’æ¤œç´¢
twint -u imassc_official -s "ã‚·ãƒŠãƒªã‚ªã‚¤ãƒ™ãƒ³ãƒˆ -å¾©åˆ»" --videos -o sc_event.json --json --limit 1000

# ã€Œã‚¬ã‚·ãƒ£ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ±å‹•ç”»ã€ã‚’æ¤œç´¢
twint -u imassc_official -s "ã‚¬ã‚·ãƒ£ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ±" --videos -o sc_gasha.json --json --limit 1000
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨æ¤œç´¢çµæœã‚’å«ã‚“ã JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

ãŒã€è¡Œæœ«ã«ã‚»ãƒŸã‚³ãƒ­ãƒ³ãŒãªãã€ã“ã®ã¾ã¾ã§ã¯é…åˆ—ã¨ã—ã¦èª­ã¿è¾¼ã‚ãªã„ã®ã§æ‰‹ç›´ã—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```vim:vim
:%s/}/},/g
```

ã“ã‚Œã§OKã§ã™ã€‚

```jsonc:sc_gasha.json
[
  {"id": 1505063643624665093, "conversation_id": "1505063643624665093", "created_at": "2022-03-19 15:08:30 JST", "date": "2022-03-19", "time": "15:08:30", "timezone": "+0900", "user_id": 958615648799662080, "username": "imassc_official", "name": "ã‚¢ã‚¤ãƒ‰ãƒ«ãƒã‚¹ã‚¿ãƒ¼ ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼ã‚«ãƒ©ãƒ¼ã‚ºå…¬å¼", "place": "", "tweet": "ã€ŒæœŸé–“é™å®š èã“ãˆã¦ã„ã¾ã™ã‹ï¼Ÿ å†¬å„ªå­ãƒ»çœŸä¹ƒã‚¹ã‚¿ãƒ³ãƒ—ã‚¬ã‚·ãƒ£Plusã€ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ±ã‚’å‹•ç”»ã§ã”ç´¹ä»‹ã„ãŸã—ã¾ã™ã­ï½  #ã‚·ãƒ£ãƒ‹ãƒã‚¹ #idolmaster  https://t.co/VvQuag1edY", "language": "ja", "mentions": [], "urls": [], "photos": [], "replies_count": 0, "retweets_count": 2280, "likes_count": 3776, "hashtags": ["ã‚·ãƒ£ãƒ‹ãƒã‚¹", "idolmaster"], "cashtags": [], "link": "https://twitter.com/imassc_official/status/1505063643624665093", "retweet": false, "quote_url": "https://twitter.com/imassc_official/status/1505063015292366848", "video": 1, "thumbnail": "https://pbs.twimg.com/ext_tw_video_thumb/1505063202748780546/pu/img/Z7_2g_k9kkNiMvKj.jpg", "near": "", "geo": "", "source": "", "user_rt_id": "", "user_rt": "", "retweet_id": "", "reply_to": [], "retweet_date": "", "translate": "", "trans_src": "", "trans_dest": ""},
  {"id": 1501801978669993986, "conversation_id": "1501801978669993986", "created_at": "2022-03-10 15:07:48 JST", "date": "2022-03-10", "time": "15:07:48", "timezone": "+0900", "user_id": 958615648799662080, "username": "imassc_official", "name": "ã‚¢ã‚¤ãƒ‰ãƒ«ãƒã‚¹ã‚¿ãƒ¼ ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼ã‚«ãƒ©ãƒ¼ã‚ºå…¬å¼", "place": "", "tweet": "ã€ŒSHEER å††é¦™ãƒ»æ„›ä¾ã‚¹ã‚¿ãƒ³ãƒ—ã‚¬ã‚·ãƒ£ã€ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ±ã‚’å‹•ç”»ã§ã”ç´¹ä»‹ã„ãŸã—ã¾ã™ã­ï½  #ã‚·ãƒ£ãƒ‹ãƒã‚¹ #idolmaster  https://t.co/jS913EfKD2", "language": "ja", "mentions": [], "urls": [], "photos": [], "replies_count": 1, "retweets_count": 1951, "likes_count": 3322, "hashtags": ["ã‚·ãƒ£ãƒ‹ãƒã‚¹", "idolmaster"], "cashtags": [], "link": "https://twitter.com/imassc_official/status/1501801978669993986", "retweet": false, "quote_url": "https://twitter.com/imassc_official/status/1501801021454102530", "video": 1, "thumbnail": "https://pbs.twimg.com/ext_tw_video_thumb/1501801566273437698/pu/img/DoqJ66rj1-kgJLyA.jpg", "near": "", "geo": "", "source": "", "user_rt_id": "", "user_rt": "", "retweet_id": "", "reply_to": [], "retweet_date": "", "translate": "", "trans_src": "", "trans_dest": ""}
  // ...
]
```

## 2. å‹•ç”»ã‚’ä¿å­˜ã™ã‚‹

å…ˆã»ã©ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ„ã‚¤ãƒ¼ãƒˆã®IDã‚’èª­ã¿è¾¼ã¿ã€Twitter APIã® [statuses/lookup](https://developer.twitter.com/en/docs/twitter-api/v1/tweets/post-and-engage/api-reference/get-statuses-lookup) ã‚’å©ã„ã¦å‹•ç”»ã®URLã‚’å–å¾—ã€‚ãã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å‹•ç”»ã‚’ä¿å­˜ã—ã¦ã„ãã¾ã™ã€‚

ä»Šå›ä½¿ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã„ã¦ã„ã¾ã™ã€‚

Denoã€ä¾¿åˆ© ğŸ¦•

https://github.com/arrow2nd/dl-twitter-img

ã“ã‚Œã§ `out/sc_event` ä»¥ä¸‹ã«å‹•ç”»ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚

```sh
deno run -A main.js sc_event.json --video
```

### å¼•ã£ã‹ã‹ã£ãŸã¨ã“: Twitter API ã‹ã‚‰å‹•ç”»ã® URL ã‚’å–å¾—ã™ã‚‹

ç¾åœ¨æä¾›ã•ã‚Œã¦ã„ã‚‹Twitter API v2ã§ã¯ [ãƒ„ã‚¤ãƒ¼ãƒˆã«æ·»ä»˜ã•ã‚ŒãŸå‹•ç”»ã® URL ãŒå–å¾—ã§ããªã„](https://developer.twitter.com/en/docs/twitter-api/data-dictionary/object-model/media)[^1] ã®ã§ã€å¾“æ¥ã®Standard v1.1ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚

ã¾ãŸã€v1ã§ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« `tweet_mode=extended` ã‚’ä»˜åŠ ã—ãªã„ã¨ `extended_entities` ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œãªã„ã®ã§ãŠå¿˜ã‚Œãªãã€‚..ã€‚

ä»¥ä¸‹ã€è©²å½“ã™ã‚‹å‡¦ç†ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

ãªã‚‹ã¹ããã‚Œã„ãªç”»åƒãŒæ¬²ã—ã„ã®ã§ã€ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆãŒä¸€ç•ªé«˜ã„å‹•ç”»ã®URLã‚’è¿”ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```js:twitter.js
/**
 * å‹•ç”»ã®URLã‚’å–å¾—
 * @param {string[]} ids ãƒ„ã‚¤ãƒ¼ãƒˆIDã®é…åˆ—
 * @returns å‹•ç”»URLã®é…åˆ—
 */
export async function fetchVideoUrl(ids) {
  const limit = 100;

  /** @type {string[]} */
  let results = [];

  // `statuses/lookup` ã«ä¸€åº¦ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãã‚‹ãƒ„ã‚¤ãƒ¼ãƒˆæ•°ã¯ 100 ä»¶ã¾ã§ãªã®ã§ã€
  // 100ä»¶ãšã¤ã«åˆ†å‰²ã—ã¦æŠ•ã’ã‚‹

  for (let i = 0; i < Math.ceil(ids.length % limit); i += limit) {
    // NOTE: API v2ã§ã¯å‹•ç”»ã®URLãŒå–å¾—ã§ããªã„ã®ã§v1.1ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
    const endpointUrl = new URL(
      "https://api.twitter.com/1.1/statuses/lookup.json"
    );

    endpointUrl.searchParams.append("tweet_mode", "extended");
    endpointUrl.searchParams.append("id", ids.slice(i, i + limit).join(","));

    const res = await fetch(endpointUrl.toString(), {
      headers: {
        Authorization: `Bearer ${Deno.env.get("BEARER_TOKEN")}`,
      },
    });

    /** @type {TweetResponse[]} */
    const json = await res.json();

    const urls = json.map((e) => {
      const variants = e.extended_entities.media[0].video_info.variants.filter(
        (e) => typeof e.bitrate !== "undefined"
      );

      // ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆã§é™é †ã‚½ãƒ¼ãƒˆ
      variants.sort((a, b) => b.bitrate - a.bitrate);

      return variants[0].url;
    });

    results = results.concat(urls);
  }

  return results;
}
```

## 3. å‹•ç”»ã‹ã‚‰ãƒ­ã‚´éƒ¨åˆ†ã®ãƒ•ãƒ¬ãƒ¼ãƒ ç”»åƒã‚’æŠœãå‡ºã™

[FFmpeg](https://ffmpeg.org) ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

### ã‚¬ã‚·ãƒ£ã®å‹•ç”»ã®å ´åˆ

å‹•ç”»ã®å†’é ­1ç§’ã‹ã‚‰2ç§’é–“ç¨‹åº¦ãƒ­ã‚´ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ãã“ã‚’ç”»åƒã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

> å‚è€ƒ: [æœŸé–“é™å®š èã“ãˆã¦ã„ã¾ã™ã‹ï¼Ÿ å†¬å„ªå­ãƒ»çœŸä¹ƒã‚¹ã‚¿ãƒ³ãƒ—ã‚¬ã‚·ãƒ£ Plus](https://twitter.com/imassc_official/status/1505063643624665093?s=20&t=U-gWeu_P5BN6BOClFyxFvw)

```sh
for file in *.mp4; do
  ffmpeg -ss 1 -i "$file" -t 2 -r 1 "${file%.*}_%d.png"
done
```

### ã‚·ãƒŠãƒªã‚ªã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ

[ã€ŒStar n dew by meã€](https://twitter.com/imassc_official/status/1188742448941535232?s=20&t=U-gWeu_P5BN6BOClFyxFvw)ã®ã‚ˆã†ã«æœ€åˆã«ãƒ­ã‚´ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã€[ã€Œå¤©å¡µã€](https://mobile.twitter.com/imassc_official/status/1276757401715314688)ã®ã‚ˆã†ã«æœ€å¾Œã«ãƒ­ã‚´ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€2ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®2ã¤ã«å¯¾å¿œã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```sh
for file in *.mp4; do
  # å†’é ­2ç§’ã‹ã‚‰ã®2ç§’é–“ã‚’åˆ‡ã‚Šå‡ºã™
  ffmpeg -ss 2 -i "$file" -t 2 -r 1 "${file%.*}_0_%d.png"
  # æœ«å°¾4ç§’å‰ã‹ã‚‰ã®2ç§’é–“ã‚’åˆ‡ã‚Šå‡ºã™
  ffmpeg -sseof -4 -i "$file" -t 2 -r 1 "${file%.*}_1_%d.png"
done
```

## 4. é¸åˆ¥ã™ã‚‹

ä»¥ä¸Šã¾ã§ã®å·¥ç¨‹ã‚’è¸ã‚€ã¨pngç”»åƒãŒä½•æšã‹å‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ã€äººåŠ›ã§é¸åˆ¥ã—ã¦ã„ãã¾ã™ ğŸ’ª

# ã‚ã¨ãŒã

![image.png](/images/433909fc4f70c4/results.png)

ã‚¬ã‚·ãƒ£ã«ã¤ã„ã¦ã¯ä¸€éƒ¨Twitterã«å‹•ç”»ãŒä¸ŠãŒã£ã¦ã„ãªã„ã‚‚ã®ãŒã‚ã‚‹ã‚ˆã†ã§ã€ã™ã¹ã¦ã¯åé›†ã§ãã¾ã›ã‚“ã§ã—ãŸãŒã€æº€è¶³ã®ã„ãé‡ã‚’é›†ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

ã¾ãŸã€ã‚·ãƒŠãƒªã‚ªã‚¤ãƒ™ãƒ³ãƒˆã«ã¤ã„ã¦ã¯ã»ã¨ã‚“ã©ç¶²ç¾…ã§ããŸã¨æ€ã„ã¾ã™ï¼âœŒï¸

![image.png](/images/433909fc4f70c4/pdesk.png)

ã“ã“ã¾ã§ã‚„ã£ãŸå¾Œã€æœ€è¿‘å®Ÿè£…ã•ã‚ŒãŸã€ŒPãƒ‡ã‚¹ã‚¯ã€ã¨ã„ã†æ©Ÿèƒ½ã§ã‚·ãƒŠãƒªã‚ªã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ­ã‚´ãŒè¦‹ã‚‰ã‚Œã‚‹ã“ã¨ã«æ°—ä»˜ã„ãŸã®ã¯å†…ç·’ã§ã™ã€‚..ã€‚

[^1]: è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ï¼ˆ2022/08/05ï¼‰ã§ã¯ `Note that video URLs are not currently available, only static images.` ã¨ã®è¨˜è¼‰ãŒã‚ã‚Šã¾ã—ãŸã€‚
