---
title: "2023年 わたしの Neovim"
emoji: "😽"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Neovim"]
published: false
---

# はじめに

こんにちは、あろーです。

Neovim をメインのエディタとして使いはじめてから、[ちょうど一年くらい](https://github.com/arrow2nd/dotfiles/commit/0a635a4e4ea3e47520404a3df8697f98c3ff5875) が経っていました。

ひとつの区切りとして、なんだかちょうど良い感じがしたので現在のわたしの環境についてまとめてみたいと思います。

# 設定の方針

厳密に守っているわけではありませんが、以下の方針で設定しています。

- 設定は基本 Lua で書きます
- プラグインの実装に使われている言語は問いません（Vim script で実装されているから使わないなどはしない）
- 常に表示される情報は最小限に留め、できるだけシンプルな画面を維持します
- 起動速度にはあまりこだわりません。気にならない程度の速度であればよしとしています（沼すぎるので…）

# わたしの使い方

- OS は macOS、または Linux を使います
- ターミナルは Wezterm です
- コーディングからドキュメント作成、Git の操作など、だいたいを Neovim の中で行います
- タブはほとんど使いません
- ウィンドウサイズの変更やスクロール操作にはマウスを使うこともあります

# 設定

## オプション

Vim を初めて触ったときからそのままになっている箇所もあるので、ブラッシュアップを兼ねてそろそろ vimrc 読書会で読んでいただくのもアリかな…と思っています。

:::details options.lua

```lua
local opt = vim.opt

-- 文字コード
vim.scriptencoding = 'utf-8'
opt.encoding = 'utf-8'
opt.fileencoding = 'utf-8'

-- 24bitカラー
opt.termguicolors = true

-- statusline を下部に固定
opt.laststatus = 3

-- intro を非表示
opt.shortmess = 'I'

-- 行
opt.number = false
opt.signcolumn = 'yes'
opt.cursorline = true

-- ヘルプの言語
opt.helplang = 'ja'

-- バックアップ, スワップファイル
opt.backup = false
opt.swapfile = false

-- buffer切り替え時の未保存警告をオフ
opt.hidden = true

-- 行末までカーソルを移動可能に
opt.virtualedit = 'onemore'

-- マウス操作有効化
opt.mouse = 'a'

-- 不可視文字可視化
opt.list = true
opt.listchars = { tab = '>>', trail = '-', nbsp = '+' }

-- タブ, インデント
opt.tabstop = 2
opt.expandtab = true
opt.shiftwidth = 2
opt.smartindent = true

-- 検索
opt.ignorecase = true
opt.smartcase = true
opt.incsearch = true

-- ヒストリの上限
opt.history = 512

-- 補完
opt.completeopt = 'menuone,noinsert'

-- LSPの警告フォーマット
-- ref: https://dev.classmethod.jp/articles/eetann-change-neovim-lsp-diagnostics-format/
vim.lsp.handlers['textDocument/publishDiagnostics'] = vim.lsp.with(vim.lsp.diagnostic.on_publish_diagnostics, {
  virtual_text = {
    format = function(diagnostic)
      return string.format('%s (%s: %s)', diagnostic.message, diagnostic.source, diagnostic.code)
    end,
  },
})

-- 自動フォーマットを無視して保存
vim.api.nvim_create_user_command('W', 'noautocmd w', {})
```

:::

このなかで~~地味に~~重宝しているのが、不可視文字を見えるようにする設定です。

```lua
-- 不可視文字可視化
opt.list = true
opt.listchars = { tab = '>>', trail = '-', nbsp = '+' }
```

普段はあまりないですが、他の方のプロジェクトを触る際に「このインデントは…スペースじゃ…ない…！？」ってなる時があるので助かっています。

## キーマップ

プラグインに依存しないキーマップの設定をこのファイルにまとめています。

:::details keymaps.lua

```lua
local h = require('util.helper')

-- リーダーキー
vim.g.mapleader = ' '

-- 行移動
h.nmap('j', 'gj')
h.nmap('k', 'gk')
h.nmap('gj', 'j')
h.nmap('gk', 'k')

-- タブ
h.nmap(']t', '<CMD>tabnext<CR>', { desc = 'Switch to next tab' })
h.nmap('[t', '<CMD>tabprevious<CR>', { desc = 'Switch to previous tab' })

-- バッファ
h.nmap(']b', '<CMD>bnext<CR>', { desc = 'Switch to next buffer' })
h.nmap('[b', '<CMD>bprevious<CR>', { desc = 'Switch to previous buffer' })

-- ハイライト解除
h.nmap('<ESC><ESC>', '<CMD>nohlsearch<CR>', { desc = 'Unhighlight' })

-- ヒストリ選択
h.omap('<C-p>', '<Up>')
h.omap('<C-n>', '<Down>')

-- quickfix
h.nmap('[q', '<Cmd>cprevious<CR>')
h.nmap(']q', '<Cmd>cnext<CR>')

-- ESCでターミナルを抜ける
h.tmap('<ESC>', '<C-\\><C-n>')
```

:::

```lua
-- リーダーキー
vim.g.mapleader = ' '
```

デカくて押しやすいので、リーダーキーはスペースに割りあてています。

```lua
-- 行移動
h.nmap('j', 'gj')
h.nmap('k', 'gk')
h.nmap('gj', 'j')
h.nmap('gk', 'k')
```

また、表示行単位で移動できるほうが好みなので `j` `k` を `gj` `gk` と入れ替えています。

少し前までは `<ESC>` を `jj` に割り当てたりもしていましたが、Vim ではないところでも `jj` を打ちまくる人間になってしまったのでやめました。

# プラグイン

以下、導入しているプラグインをジャンル別に紹介していきます。

## プラグインマネージャー

### lazy.nvim

最近よく聞く、モダンな感じの Lua 製プラグインマネージャーです。

https://github.com/folke/lazy.nvim

以前は dein.vim を使っていましたが、設定ファイルを Lua へ移行する際にこちらへ乗り換えました。

簡単に扱えてリッチな UI が付いてくるのが好きなところなのですが、遅延読み込みについては dein.vim の方がカリカリにチューニングできそうです。

## カラースキーム

### iceberg.vim

暗めのブルーを基調とした、落ちついた雰囲気のカラースキームです。

https://github.com/cocopon/iceberg.vim

定期的に他のカラースキームも試してみるのですが、結局これに帰ってきてしまうくらいお気に入りです。

## ファジーファインダー

### telescope.nvim

Neovim における定番になっていそうなファジーファインダー（あいまい検索）のプラグインです。

https://github.com/nvim-telescope/telescope.nvim

ファイルの検索やブラウジング、リアルタイムな grep や LSP のエラー検索など、色々な操作をこれひとつで行っています。

ビルドインの機能に加えて、以下の拡張プラグインを導入しています。

#### telescope-file-browser.nvim

ファイラーの機能を追加するプラグインです。

https://github.com/nvim-telescope/telescope-file-browser.nvim

#### telescope-kensaku.nvim

ローマ字での日本語検索を提供する [kensaku.vim](https://github.com/lambdalisue/kensaku.vim) を利用して、全文検索をできるようにするプラグインです。

https://github.com/Allianaab2m/telescope-kensaku.nvim

#### telescope-ui-select.nvim

`vim.ui.select` を Telescope に置きかえるプラグインです。

https://github.com/nvim-telescope/telescope-ui-select.nvim

## LSP

Neovim 組込みの LSP クライアントを使うために以下のプラグインを導入しています。

- LSP の設定：[nvim-lspconfig](https://github.com/neovim/nvim-lspconfig)
- 言語サーバーの管理：[mason.nvim](https://github.com/williamboman/mason.nvim)
  - lspconfig との連携：[mason-lspconfig.nvim](https://github.com/williamboman/mason-lspconfig.nvim)

これに加えて LSP に対応していない Linter や Formatter（Textlint や Prettier など）を扱うために、null-ls を使っています。

https://github.com/jose-elias-alvarez/null-ls.nvim

### nvim-treesitter

## 入力周り

### ddc.vim

- pum.vim
- denops-popup-preview.vim
- denops-signature_help
- vim-vsnip

### skkeleton

### nvim-ts-autotag

### dial.nvim

## Git

### neogit.nvim

### diffview.nvim

### git-messenger.vim

### gitsigns.nvim

## 移動

### chowcho.nvim

### fuzzy-motion.vim

## 便利

### qfreplace

### mini.nvim

- mini.comment
- mini.splitjoin
- mini.pairs
- mini.surround
- mini.indentscope
- mini.statusline

### nvim-colorizer.lua

### denops-translate.vim

### bufpreview.vim

### vim-floaterm

# おわりに
