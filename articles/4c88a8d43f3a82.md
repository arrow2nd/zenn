---
title: "TUIなTwitterクライアント「nekome」を作った"
emoji: "🐈"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [twitter, tui, golang]
published: false
---

# どんなの？

![スクリーンショット](/images/4c88a8d43f3a82/nekome.gif)
_※ アイコンや配色はちょっとカスタマイズしています_

↑ こんなの

タブ形式でページを複数開くことができ、 Vim っぽいキーバインドでさくさく使える TUI の Twitter クライアントです。

# 何ができるの？

以下のことができます。

- ホーム・メンション・リストタイムラインの閲覧
- アンケートの投票状況・ピン留めツイートの表示
- ツイートの投稿・削除
- ツイートに対してのいいね・RT・QT・リプライ
- ユーザのフォロー・ブロック・ミュート
- アカウントの切り替え（マルチアカウント）

これに加えて最近、**ストリームモード** という TweetDeck のようにツイートが流れる機能を実装しました！

![ストリームモード](/images/4c88a8d43f3a82/stream.gif)

かなりアプローチは違いますが、今は亡き UserStream の雰囲気を味わうことができます...

# インストール

macOS で HomeBrew 導入済みなら

```
brew tap arrow2nd/tap
brew install nekome
```

Windows で Scoop 導入済みなら

```
scoop bucket add arrow2nd https://github.com/arrow2nd/scoop-bucket.git
scoop install arrow2nd/nekome
```

Linux または上記以外の環境なら [Releases](https://github.com/arrow2nd/nekome/releases) からビルド済みバイナリをダウンロードできます。

:::message
`go install github.com/arrow2nd/nekome@latest` でもインストールできますが、コンシューマーキーが内蔵されていないため、そのままでは使うことができません。
詳しくは [README](https://github.com/arrow2nd/nekome#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB) をご覧ください。
:::

# つかいかた

![初期設定](/images/4c88a8d43f3a82/init.png)

初回起動時は認証ページにアクセスして PIN コードを取得し、nekome に入力する必要があります。

ここで取得したアクセストークン等は `~/.config/nekome/.cred` 内に保存されます。

## TUI モード

基本的にショートカットキーと `:` から始まるコマンドを使って操作します。

![ショートカットのヘルプ](/images/4c88a8d43f3a82/shortcuts.png)

例えば、↑ のショートカットのヘルプページは `?` を入力するか、`:docs shortcuts` で開くことができます。

![入力補完](/images/4c88a8d43f3a82/autocomp.png)

また、コマンドは入力補完が効きます。
ちょっと便利です 👍

## CLI モード

![コマンドのヘルプ](/images/4c88a8d43f3a82/help.png)

アカウント・設定ファイルの操作のほか、ツイートの投稿を行うことができます。

![CLIモードでのツイート](/images/4c88a8d43f3a82/tweet.png)
_[omekasy](https://github.com/ikanago/omekasy)で英字を変換してツイートする例_

`tweet` コマンドは標準入力にも対応しているので、ツールの出力をそのままツイートするみたいなことも可能です。

# 開発時につまづいたこと

## 文字の表示幅

絵文字などの一部の文字を表示すると画面が乱れるという問題がありました。

https://twitter.com/arrow_2nd/status/1535850336916602880?s=20&t=j4tMG5UnvTu2lKHj8WXy6Q

↑ のツイートにもあるように、go-runewidth で正しい表示幅が取得できないケースがあるのが原因でした。（端末によって表示幅が異なる文字もあるので、解決するのはとても難しそう）

https://github.com/rivo/tview/issues/693
https://github.com/mattn/go-runewidth/issues/59

この件については既に issue が立って議論されていたので、様子をみたいと思います。
nekome では暫定的な対応として、`Ctrl + l` で画面を再描画できるようにしました！

## OAuth 2.0 with PKCE

ブックマークや Spaces のエンドポイントを叩くためには [OAuth 2.0 Authorization Code Flow with PKCE](https://developer.twitter.com/en/docs/authentication/oauth-2-0/authorization-code) という認証方法を使う必要があります。

nekome ではブックマーク周りの操作にも対応する予定だったので、この認証方法を採用したのですが、一通り実装し終わった段階で **複数端末でログインができない** という問題に直面しました。

[コミュニティの投稿](https://twittercommunity.com/t/cannot-use-oauth2-with-pkce-access-token-on-multiple-devices/174692) にもあるように、「A でログインした後に B でもログインした場合、A のトークンが失効してしまう」といった挙動をします。

かなり悩んだのですが、複数端末でログインできないのは許容しがたいと判断したので、ブックマーク周りの機能は見送り、認証方法を OAuth 1.0a に変更することで解決しました。

https://github.com/arrow2nd/nekome/tree/oauth2.0

実装自体は全てここに残してあります。何かの参考になれば...

## Twitter API v2

# さいごに
